name: Simple Cherry-pick Bot

on:
  issue_comment:
    types: [created]

jobs:
  cherry-pick:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/cherry-pick') &&
      (contains(github.event.comment.author_association, 'MEMBER') || 
       contains(github.event.comment.author_association, 'OWNER') ||
       contains(github.event.comment.author_association, 'COLLABORATOR'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Extract branch from comment
        id: extract-branch
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "Comment: $COMMENT"
          
          # Extract branch name from comment like "/cherry-pick release-v0.77.x"
          BRANCH=$(echo "$COMMENT" | grep -oP '/cherry-pick\s+\K[^\s]+' || echo "")
          echo "Extracted branch: $BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.extract-branch.outputs.branch != ''
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        if: steps.extract-branch.outputs.branch != ''
        run: |
          git config user.name "tekton-robot"
          git config user.email "dlorenc+tekton@google.com"

      - name: Get PR details
        if: steps.extract-branch.outputs.branch != ''
        id: pr-details
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          PR_DATA=$(gh pr view $PR_NUMBER --json mergeCommit,title,author,url,headRefName)
          
          MERGE_COMMIT=$(echo "$PR_DATA" | jq -r '.mergeCommit.oid // empty')
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
          PR_URL=$(echo "$PR_DATA" | jq -r '.url')
          
          echo "merge_commit=$MERGE_COMMIT" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cherry-pick commit
        if: steps.extract-branch.outputs.branch != '' && steps.pr-details.outputs.merge_commit != ''
        run: |
          TARGET_BRANCH="${{ steps.extract-branch.outputs.branch }}"
          COMMIT_SHA="${{ steps.pr-details.outputs.merge_commit }}"
          PR_NUMBER="${{ github.event.issue.number }}"
          
          echo "Cherry-picking $COMMIT_SHA to $TARGET_BRANCH"
          
          # Check if target branch exists
          if ! git ls-remote --heads origin "$TARGET_BRANCH" | grep -q "refs/heads/$TARGET_BRANCH"; then
            echo "‚ùå Branch $TARGET_BRANCH does not exist"
            gh issue comment $PR_NUMBER --body "‚ùå Cherry-pick failed: Branch \`$TARGET_BRANCH\` does not exist."
            exit 1
          fi
          
          # Create cherry-pick branch
          CHERRY_PICK_BRANCH="cherry-pick-${COMMIT_SHA:0:7}-to-${TARGET_BRANCH//\//-}"
          
          # Fetch and checkout target branch
          git fetch origin "$TARGET_BRANCH"
          git checkout -b "$CHERRY_PICK_BRANCH" "origin/$TARGET_BRANCH"
          
          # Attempt cherry-pick
          if git cherry-pick "$COMMIT_SHA"; then
            echo "‚úÖ Cherry-pick successful"
            git push origin "$CHERRY_PICK_BRANCH"
            
            # Create PR
            gh pr create \
              --base "$TARGET_BRANCH" \
              --head "$CHERRY_PICK_BRANCH" \
              --title "[$TARGET_BRANCH] ${{ steps.pr-details.outputs.pr_title }}" \
              --body "Cherry-pick of #$PR_NUMBER to \`$TARGET_BRANCH\`

**Original PR:** ${{ steps.pr-details.outputs.pr_url }}
**Original commit:** $COMMIT_SHA
**Requested by:** @${{ github.event.comment.user.login }}

/cc @${{ steps.pr-details.outputs.pr_author }}" \
              --label "cherry-pick"
            
            # Comment on original PR
            gh issue comment $PR_NUMBER --body "‚úÖ Cherry-pick to \`$TARGET_BRANCH\` created successfully! üéâ"
            
          else
            echo "‚ùå Cherry-pick failed due to conflicts"
            git cherry-pick --abort
            
            # Comment on original PR with manual instructions
            gh issue comment $PR_NUMBER --body "‚ùå Cherry-pick to \`$TARGET_BRANCH\` failed due to conflicts.

**Manual cherry-pick required:**
\`\`\`bash
git fetch origin $TARGET_BRANCH
git checkout -b cherry-pick-$PR_NUMBER-to-$TARGET_BRANCH origin/$TARGET_BRANCH
git cherry-pick $COMMIT_SHA
# Resolve conflicts, then:
git add .
git cherry-pick --continue
git push origin cherry-pick-$PR_NUMBER-to-$TARGET_BRANCH
# Create PR manually
\`\`\`

/cc @${{ steps.pr-details.outputs.pr_author }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

